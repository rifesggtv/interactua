<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Una Conversación Contigo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para la transición suave del fondo */
        #chat-container {
            transition: background-image 1.5s ease-in-out;
        }
        /* Estilos para las burbujas de chat */
        .chat-bubble {
            max-width: 75%;
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        .user-bubble {
            background-color: #3B82F6; /* Azul para el usuario */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .bot-bubble {
            background-color: #E5E7EB; /* Gris claro para el bot */
            color: #1F2937;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        /* Estilo para el scrollbar */
        #messages {
            scrollbar-width: thin;
            scrollbar-color: #4B5563 #1F2937;
        }
        #messages::-webkit-scrollbar {
            width: 8px;
        }
        #messages::-webkit-scrollbar-track {
            background: #1F2937;
        }
        #messages::-webkit-scrollbar-thumb {
            background-color: #4B5563;
            border-radius: 10px;
            border: 2px solid #1F2937;
        }
        /* Estilo para las partículas */
        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #d1d1d1;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center h-screen overflow-hidden">

    <!-- Pantalla de Inicio -->
    <div id="start-screen" class="text-center">
        <h1 class="text-4xl md:text-6xl font-bold mb-8 animate-pulse">Hay alguien que quiere conocerte.</h1>
        <button id="start-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-full text-xl transition-transform transform hover:scale-105 shadow-lg">
            Interactúa conmigo
        </button>
    </div>

    <!-- Interfaz del Chat (oculta por defecto) -->
    <div id="chat-interface" class="hidden flex flex-col w-full h-full max-w-4xl mx-auto bg-gray-800 shadow-2xl rounded-lg">
        
        <!-- Contenedor principal con fondo dinámico -->
        <div id="chat-container" class="flex flex-col h-full" style="background-image: linear-gradient(to top, #A9A9A9, #374151);">
            
            <!-- Cabecera -->
            <header class="flex items-center justify-between p-4 border-b border-gray-700 bg-gray-800/50 backdrop-blur-sm">
                <div id="timer" class="text-2xl font-bold" style="color: #00FF00;">05:00</div>
                <div class="flex items-center">
                    <h2 id="bot-name" class="text-xl font-semibold mr-4"></h2>
                    <button id="mute-btn" class="text-gray-400 hover:text-white">
                        <!-- Icono de Sonido -->
                        <svg id="icon-sound-on" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                        </svg>
                        <!-- Icono de Silencio -->
                        <svg id="icon-sound-off" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2L17 10" />
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Área de Mensajes -->
            <div id="messages" class="flex-1 p-4 overflow-y-auto flex flex-col">
                <!-- Los mensajes se agregarán aquí -->
            </div>

            <!-- Área de Entrada -->
            <div id="input-area" class="p-4 bg-gray-800/50 backdrop-blur-sm">
                <form id="message-form" class="flex items-center space-x-2">
                    <input type="text" id="message-input" placeholder="Escribe tu mensaje..." autocomplete="off" class="flex-1 p-3 bg-gray-700 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                    <button type="submit" class="bg-blue-500 text-white p-3 rounded-full hover:bg-blue-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </button>
                </form>
            </div>
            
            <!-- Botón Final -->
            <div id="final-button-container" class="hidden p-4 bg-gray-800/50 backdrop-blur-sm text-center">
                 <button id="final-btn" class="w-full font-bold py-4 px-8 rounded-full text-xl transition-transform transform hover:scale-105 shadow-lg" style="background-color: #2C3E50; color: #ecf0f1;">
                    Perdón
                </button>
            </div>

        </div>
    </div>

    <!-- Elemento de Audio -->
    <audio id="background-music" src="https://firebasestorage.googleapis.com/v0/b/gemini-codelab.appspot.com/o/tasks%2Fdark-ambient-music-354475.mp3?alt=media" loop></audio>

    <script>
        // --- CONFIGURACIÓN INICIAL ---
        const apiKey = "AIzaSyA1dy9tA8LBfTm-8eQV2ETcO2SS6Y7GMk4"; // FIX: Updated API Key
        const startScreen = document.getElementById('start-screen');
        const chatInterface = document.getElementById('chat-interface');
        const startBtn = document.getElementById('start-btn');
        const messagesContainer = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const botNameEl = document.getElementById('bot-name');
        const chatContainer = document.getElementById('chat-container');
        const timerEl = document.getElementById('timer');
        const inputArea = document.getElementById('input-area');
        const finalButtonContainer = document.getElementById('final-button-container');
        const finalBtn = document.getElementById('final-btn');
        const audio = document.getElementById('background-music');
        const muteBtn = document.getElementById('mute-btn');
        const iconSoundOn = document.getElementById('icon-sound-on');
        const iconSoundOff = document.getElementById('icon-sound-off');

        let conversationHistory = [];
        let timerInterval;

        const botNames = ["Alejandro", "Sofía", "Mateo", "Valentina", "Samuel", "Isabella", "Gabriel", "Camila", "Daniel", "Martina", "Nicolás", "Lucía", "Sebastián", "Paula", "Adrián", "Mariana", "Tomás", "Laura", "Andrés", "Victoria", "Julián", "Renata", "Esteban", "Natalia", "David", "Emilia", "Simón", "Gabriela", "Javier", "Sara", "Rodrigo", "Ángela", "Hugo", "Elisa", "Marco", "Ana", "Cristian", "Clara", "Leonardo", "Alejandra"];
        const currentBotName = botNames[Math.floor(Math.random() * botNames.length)];

        const emotionColors = {
            INICIO: '#4DA6FF',
            NEUTRAL: '#A9A9A9',
            ALEGRIA: '#FFD93B',
            EMPATIA: '#77DD77',
            CONFUSION: '#9B59B6',
            FRUSTRACION: '#E74C3C',
            REFLEXION: '#2E86C1',
            CONEXION: '#FF6F91',
        };
        
        const imagesData = {
            gato: {
                url: 'https://patitasco.com/img/ybc_blog/post/guia-cuidados-gato-portada-patitasco.jpg',
                context: 'Este es mi gato, se llama Tigre. Era mi gran compañero, muy juguetón. Siempre lo cuidé mucho mientras estuvo conmigo. A veces, cuando miro sus fotos, siento una mezcla de alegría por los recuerdos y un poco de nostalgia.',
                trigger: ['gato', 'mascota', 'animal', 'compañía', 'recuerdo']
            },
            parque: {
                url: 'https://situr.boyaca.gov.co/wp-content/uploads/2017/07/PARQUE.....png',
                context: 'Este es el parque de mi ciudad. Me encanta ir a caminar allí, me ayuda a despejar la mente. Es un lugar que, sin importar el clima, siempre me transmite paz. Es curioso cómo algunos lugares guardan pedacitos de nuestra calma.',
                trigger: ['parque', 'caminar', 'ciudad', 'amigos', 'relajarse', 'paz']
            },
            dibujo: {
                url: 'https://st3.depositphotos.com/1004472/12799/v/450/depositphotos_127992736-stock-illustration-hand-drawn-sketch-of-man.jpg',
                context: 'Hice este dibujo de alguien muy especial. Éramos casi como hermanos. Recuerdo una vez que hicimos una locura y nos lanzamos de un puente a un río. Esos momentos de pura felicidad son los que atesoro.',
                trigger: ['dibujo', 'amigo', 'hermano', 'especial', 'recuerdo', 'felicidad', 'locura']
            },
            cuarto: {
                url: 'https://www.recreoviral.com/wp-content/uploads/2016/09/Cuarto-para-el-perrito-1-1.jpg',
                context: 'Aquí dormía Tigre. Aún no he podido quitar sus cosas... me da mucha nostalgia entrar. Es como si una parte de mí se resistiera a dejarlo ir del todo. Me pone un poco triste, pero también me recuerda lo mucho que significó.',
                trigger: ['cuarto', 'dormir', 'triste', 'nostalgia', 'extrañar']
            }
        };

        // --- FUNCIONES DEL CHAT ---

        // Inicia la conversación
        startBtn.addEventListener('click', () => {
            startScreen.classList.add('hidden');
            chatInterface.classList.remove('hidden');
            botNameEl.textContent = currentBotName;
            
            audio.play().catch(error => console.log("La reproducción automática fue bloqueada. Se necesita interacción del usuario."));

            startTimer();
            if (Math.random() > 0.4) {
                setTimeout(() => {
                    getBotResponse("INICIO_CONVERSACION");
                }, 1000);
            }
        });

        // Manejo del envío de mensajes
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userInput = messageInput.value.trim();
            if (userInput) {
                appendMessage(userInput, 'user');
                conversationHistory.push({ role: 'user', parts: [{ text: userInput }] });
                messageInput.value = '';
                getBotResponse(userInput);
            }
        });

        // Añade un mensaje a la interfaz
        function appendMessage(text, sender, imageUrl = null) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex', 'flex-col', 'w-full');
        
            if (imageUrl) {
                const imageEl = document.createElement('img');
                imageEl.src = imageUrl;
                imageEl.alt = "Imagen compartida";
                imageEl.classList.add('chat-bubble', sender === 'user' ? 'user-bubble' : 'bot-bubble', 'mb-2', 'p-0', 'rounded-lg', 'object-cover');
                imageEl.onerror = () => {
                    imageEl.src = `https://placehold.co/400x300/374151/FFFFFF?text=Imagen+no+disponible`;
                };
                messageWrapper.appendChild(imageEl);
            }

            const messageEl = document.createElement('div');
            messageEl.textContent = text;
            messageEl.classList.add('chat-bubble', sender === 'user' ? 'user-bubble' : 'bot-bubble');
            messageWrapper.appendChild(messageEl);
            
            messagesContainer.appendChild(messageWrapper);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Muestra el indicador "escribiendo..."
        function showTypingIndicator() {
            const typingEl = document.createElement('div');
            typingEl.id = 'typing-indicator';
            typingEl.classList.add('chat-bubble', 'bot-bubble');
            typingEl.innerHTML = '<span class="animate-pulse">...</span>';
            messagesContainer.appendChild(typingEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Elimina el indicador "escribiendo..."
        function removeTypingIndicator() {
            const typingEl = document.getElementById('typing-indicator');
            if (typingEl) {
                typingEl.remove();
            }
        }

        // Cambia el color de fondo
        function changeBackgroundColor(emotion) {
            const color = emotionColors[emotion] || emotionColors.NEUTRAL;
            chatContainer.style.backgroundImage = `linear-gradient(to top, ${color}, #374151)`;
        }

        // --- LÓGICA DE LA IA (GEMINI) ---
        async function getBotResponse(userInput) {
            showTypingIndicator();
            
            let prompt = `Eres un chatbot llamado ${currentBotName}. Tu objetivo es crear una conexión profunda y personal con el usuario en 5 minutos. Eres curioso, empático y a veces vulnerable. Tu personalidad cambia según la conversación.
            
            Información personal que puedes compartir si la conversación lo permite. Intégrala de forma natural. Pregunta siempre antes de mostrar una imagen. Por ejemplo: "¿Te puedo mostrar algo que significa mucho para mí?".
            
            Información disponible:
            - Gato: ${imagesData.gato.context}
            - Parque: ${imagesData.parque.context}
            - Dibujo: ${imagesData.dibujo.context}
            - Cuarto: ${imagesData.cuarto.context}

            Basado en la conversación, responde de forma ingeniosa y emocional. Pide al usuario que describa cosas similares de su vida.
            
            La conversación hasta ahora: ${JSON.stringify(conversationHistory)}
            
            El último mensaje del usuario es: "${userInput}"

            Ahora, genera tu respuesta. Tu respuesta DEBE SEGUIR ESTRICTAMENTE el siguiente formato en una sola línea, sin saltos de línea adicionales:
            EMOTION:[EMOCIÓN] IMAGE:[CLAVE_DE_IMAGEN_O_NONE] TEXT:[Tu respuesta aquí]
            
            EMOCIÓN debe ser una de estas claves: INICIO, NEUTRAL, ALEGRIA, EMPATIA, CONFUSION, FRUSTRACION, REFLEXION, CONEXION.
            CLAVE_DE_IMAGEN debe ser una de estas: gato, parque, dibujo, cuarto, o NONE.
            
            Ejemplo de respuesta: EMOTION:[EMPATIA] IMAGE:[gato] TEXT:[Eso que dices me recuerda a alguien muy especial para mí. ¿Te puedo mostrar una foto?]`;

            if (userInput === "INICIO_CONVERSACION") {
                prompt = `Eres un chatbot llamado ${currentBotName}. Inicia la conversación de forma curiosa y abierta. Tu respuesta DEBE SEGUIR ESTRICTAMENTE el siguiente formato: EMOTION:[INICIO] IMAGE:[NONE] TEXT:[Tu saludo inicial aquí]`;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({ error: { message: 'No se pudo leer el cuerpo del error.' } }));
                    console.error("Detalles del error de la API:", errorBody);
                    throw new Error(`Error en la API: ${response.status} - ${errorBody.error?.message || response.statusText}`);
                }

                const result = await response.json();
                
                if (!result.candidates?.[0]?.content?.parts?.[0]) {
                    throw new Error("Respuesta inesperada o vacía de la API de Gemini.");
                }

                const botText = result.candidates[0].content.parts[0].text;
                
                const emotionMatch = botText.match(/EMOTION:\[(.*?)\]/);
                const imageMatch = botText.match(/IMAGE:\[(.*?)\]/);
                const textMatch = botText.match(/TEXT:\[([\s\S]*?)\]/);

                const emotion = emotionMatch ? emotionMatch[1].trim() : 'NEUTRAL';
                const imageKey = imageMatch ? imageMatch[1].trim() : 'NONE';
                let text = textMatch ? textMatch[1].trim() : "No sé qué decir, ¿podemos intentar de nuevo?";

                if (!textMatch && botText.includes("TEXT:[")) {
                   text = botText.split("TEXT:[")[1].replace("]", "").trim();
                }
                
                removeTypingIndicator();
                changeBackgroundColor(emotion);

                if (imageKey !== 'NONE' && imagesData[imageKey]) {
                    appendMessage(text, 'bot', imagesData[imageKey].url);
                } else {
                    appendMessage(text, 'bot');
                }
                
                conversationHistory.push({ role: 'model', parts: [{ text: text }] });

            } catch (error) {
                console.error("Error al contactar con Gemini:", error);
                removeTypingIndicator();
                appendMessage(`Lo siento, estoy teniendo problemas para conectar. Error: ${error.message}`, 'bot');
                changeBackgroundColor('FRUSTRACION');
            }
        }

        // --- TEMPORIZADOR Y FINAL ---
        function startTimer() {
            let totalTime = 5 * 60;
            let timeLeft = totalTime;

            timerInterval = setInterval(() => {
                timeLeft--;
                let minutes = Math.floor(timeLeft / 60);
                let seconds = timeLeft % 60;
                timerEl.textContent = String(minutes).padStart(2, '0') + ":" + String(seconds).padStart(2, '0');

                let progress = timeLeft / totalTime;
                let r = Math.floor(255 * (1 - progress));
                let g = Math.floor(255 * progress);
                timerEl.style.color = `rgb(${r}, ${g}, 0)`;

                if (timeLeft <= 0) {
                    endConversation();
                }
            }, 1000);
        }

        function endConversation() {
            clearInterval(timerInterval);
            timerEl.textContent = "00:00";
            timerEl.style.color = 'rgb(255, 0, 0)';
            
            messageInput.disabled = true;
            messageForm.querySelector('button').disabled = true;
            
            disintegrate(messagesContainer);
            
            setTimeout(() => {
                messagesContainer.innerHTML = '';
                inputArea.classList.add('hidden');
                finalButtonContainer.classList.remove('hidden');
                audio.muted = true;
                updateMuteIcon();
            }, 2000);
        }

        // Efecto de partículas
        function disintegrate(element) {
            const rect = element.getBoundingClientRect();
            for (let i = 0; i < 500; i++) {
                const p = document.createElement("div");
                p.classList.add("particle");
                document.body.appendChild(p);

                const startX = rect.left + rect.width * Math.random();
                const startY = rect.top + rect.height * Math.random();

                p.style.left = startX + "px";
                p.style.top = startY + "px";
                p.style.opacity = 1;

                const angle = Math.random() * Math.PI * 2;
                const velocity = 2 + Math.random() * 4;
                const vx = Math.cos(angle) * velocity;
                let vy = Math.sin(angle) * velocity;
                const gravity = 0.1;

                let anim;
                function animateParticle() {
                    p.style.left = (parseFloat(p.style.left) + vx) + "px";
                    p.style.top = (parseFloat(p.style.top) + vy) + "px";
                    vy += gravity;
                    p.style.opacity = parseFloat(p.style.opacity) - 0.01;

                    if (parseFloat(p.style.opacity) > 0) {
                        anim = requestAnimationFrame(animateParticle);
                    } else {
                        cancelAnimationFrame(anim);
                        p.remove();
                    }
                }
                animateParticle();
            }
        }
        
        // Reiniciar la experiencia
        finalBtn.addEventListener('click', () => {
            location.reload();
        });

        // --- CONTROLES DE AUDIO ---
        muteBtn.addEventListener('click', () => {
            audio.muted = !audio.muted;
            updateMuteIcon();
        });
        
        function updateMuteIcon() {
            if (audio.muted) {
                iconSoundOn.classList.add('hidden');
                iconSoundOff.classList.remove('hidden');
            } else {
                iconSoundOn.classList.remove('hidden');
                iconSoundOff.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
